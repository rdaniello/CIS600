<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>COVID-19 Effects of Temperature on Infection Rate</title>
    <!-- Import external js libraries and stylesheets -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/jquery-ui.css" rel="stylesheet">
    <link href="./css/styles.css" rel="stylesheet">
    <script src="./js/jquery-3.5.1.min.js"></script>
    <script src="./js/jquery-ui.js"></script>
    <script src="./js/bootstrap.bundle.min.js"></script>
    <!-- Import project js files and styles -->
    <script src="./js/filters.js"></script> 
    <style>
        
    </style>
</head>
<body>
<div id="caption" style="text-align: center;">
    COVID-19 Effects of Temperature on Infection Rate
</div>

<div class="row" style="margin:auto">
    <div class="col-2">
        <div class="col-12 border border-primary rounded" style="background-color:rgb(245, 245, 255);">
            <div class="row" style="font-weight:bold; display:flexbox; justify-content:center;">
                <span style="text-decoration: underline;">Filters(</span>
                <span id='filteredCount'>---</span>
                <span >)</span>
            </div>
            <div class="row" style="padding:15px; text-align:center; font-size: 14px">
                <div class="row" style="text-align:left; padding-left: 5px;">Infection Rate (cases/100k):</div>
                <span type="text" id="irateSliderTxt" readonly style="border:0; color:#f6931f; font-size: 14px; width:100%; margin:auto"></span> 
                <div style="width: 95%; margin:auto" id="irateSlider"></div>
            </div>
            <div class="row" style="padding:15px; text-align:center; font-size: 14px">
                <div class="row" style="text-align:left; padding-left: 5px;">Temperature (&#176;F):</div>
                <span type="text" id="tempSliderTxt" readonly style="border:0; color:#f6931f; font-size: 14px; width:100%; margin:auto"></span> 
                <div style="width: 95%; margin:auto" id="tempSlider"></div>
            </div>
            <div class="row" style="padding:15px; text-align:center; font-size: 14px">
                <div class="row" style="text-align:left; padding-left: 5px;">Population Density (/sq mile):</div>
                <span type="text" id="popDenSliderTxt" readonly style="border:0; color:#f6931f; font-size: 14px; width:100%; margin:auto"></span> 
                <div style="width: 95%; margin:auto" id="popDenSlider"></div>
            </div>
            <div class="row" style="padding:15px; text-align:center; font-size: 14px">
                <div class="row" style="text-align:left; padding-left: 5px;">Date:</div>
                <span type="text" id="dateSliderTxt" readonly style="border:0; color:#f6931f; font-size: 14px; width:100%; margin:auto"></span> 
                <div style="width: 95%; margin:auto" id="dateSlider"></div>
            </div>
            <div class="row" style=" padding:15px; text-align:left; font-size: 14px">
                <div class="row" style="text-align:left; padding-left: 5px;">State:</div>
                <span type="text" id="dateSliderTxt" readonly style="border:0; color:#f6931f; font-size: 14px; width:100%; margin:auto"></span> 
                <div style="width: 95%; margin:auto; height:355px; overflow-y: scroll;" id="stateDiv">
                    <div id='northeast' class='stateFilterCOL'>
                        <div  class='row'>
                            <div class='col-8' onclick='toggleExpand("northeast")'><span id='neTxt'>+</span> Northeast </div>
                            <div class='col-2'><input type="checkbox" onchange='checkToggleRegion(this,"NE")' checked></div>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"09")' checked><span> Connecticut</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"23")' checked><span> Maine</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"25")' checked><span> Massachusetts</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"33")' checked><span> New Hampshire</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"34")' checked><span> New Jersey</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"36")' checked><span> New York</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"42")' checked><span> Pennsylvania</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"44")' checked><span> Rhode Island</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='NE' type="checkbox" onchange='checkBoxEvt(this,"50")' checked><span> Vermont</span>
                        </div>
                    </div>
                    <div id='southeast' class='stateFilterCOL'>
                        <div  class='row'>
                            <div class='col-8' onclick='toggleExpand("southeast")'><span id='seTxt'>+</span> South </div>
                            <div class='col-2'><input type="checkbox" onchange='checkToggleRegion(this,"SE")' checked></div>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"01")' checked><span> Alabama</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"05")' checked><span> Arkanas</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"10")' checked><span> Delaware</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"11")' checked><span> District of Columbia</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"12")' checked><span> Florida</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"13")' checked><span> Georgia</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"21")' checked><span> Kentucky</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"22")' checked><span> Louisiana</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"24")' checked><span> Maryland</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"28")' checked><span> Mississippi</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"37")' checked><span> North Carolina</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"40")' checked><span> Oklahoma</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"45")' checked><span> South Carolina</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"47")' checked><span> Tennessee</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"48")' checked><span> Texas</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"51")' checked><span> Virgina</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='SE' type="checkbox" onchange='checkBoxEvt(this,"54")' checked><span> West Virginia</span>
                        </div>  
                    </div>
                    <div id='midwest' class='stateFilterCOL'>
                        <div  class='row'>
                            <div class='col-8' onclick='toggleExpand("midwest")'><span id='mwTxt'>+</span> Midwest </div>
                            <div class='col-2'><input type="checkbox" onchange='checkToggleRegion(this,"MW")' checked></div>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"17")' checked><span> Illinois</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"18")' checked><span> Indiana</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"19")' checked><span> Iowa</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"20")' checked><span> Kanas</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"26")' checked><span> Michigan</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"27")' checked><span> Minnesota</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"29")' checked><span> Missouri</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"31")' checked><span> Nebraska</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"38")' checked><span> North Dakota</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"39")' checked><span> Ohio</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"46")' checked><span> South Dakota</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='MW' type="checkbox" onchange='checkBoxEvt(this,"55")' checked><span> Wisconsin</span>
                        </div>
                    </div>
                    <div id='west' class='stateFilterCOL'>
                        <div  class='row'>
                            <div class='col-8' onclick='toggleExpand("west")'><span id='weTxt'>+</span> West</div>
                            <div class='col-2'><input type="checkbox" onchange='checkToggleRegion(this,"WE")' checked></div>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"02")' checked><span> Alaska</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"04")' checked><span> Arizona</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"06")' checked><span> California</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"08")' checked><span> Colorado</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"15")' checked><span> Hawaii</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"16")' checked><span> Idaho</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"30")' checked><span> Montana</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"32")' checked><span> Nevada</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"35")' checked><span> New Mexico</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"41")' checked><span> Oregon</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"49")' checked><span> Utah</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"53")' checked><span> Washington</span>
                        </div>
                        <div style='margin-left: 10px;'>
                            <input class='WE' type="checkbox" onchange='checkBoxEvt(this,"56")' checked><span> Wyoming</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-center" style='margin-bottom:10px'>
                    <div onclick='resetFilters()' class="btn-primary btn ">Reset Filters</div>
            </div>
        </div>
    </div>
    <div class="col-10" >
        <div class="col-12 border border-primary rounded" style ="padding: 10px;">
            <div class="row" style="margin-bottom: 5px;">
                <div class="col-12 ">
                    <div class="col-12 border border-right-0 rounded" style="background-color:rgb(245, 245, 255);">
                        <svg id="canvasScatter" viewBox="0 0 1000 200"></svg>
                    </div>
                </div>

            </div>
            <div class="row" id="container">
                <div class="col-6 ">
                    <div class="col-12 border border-right-0 rounded" style="background-color:rgb(245, 245, 255);">
                        <div class=row>
                            <svg id="canvasMapTitle" viewBox="0 0 1000 30"></svg> 
                        </div>
                            <svg id="canvasMap" viewBox="0 0 1000 800"></svg>
                    </div>
                </div>
                <div class="col-6 ">
                    <div class="col-12 border border-right-0 rounded" style="background-color:rgb(245, 245, 255);">
                        <div class=row>
                            <svg id="canvasBarTitle" viewBox="0 0 1000 30"></svg> 
                        </div>
                        <div class='row' >
                            <svg id="canvasBarIRate" viewBox="0 0 1000 370"></svg> 
                        </div>
                        <div class=row>
                            <svg id="canvasBarDateAxis" viewBox="0 0 1000 20"></svg> 
                        </div>
                        <div class='row' >
                            <svg id="canvasBarTemp" viewBox="0 0 1000 370"></svg> 
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // global data arrays and filters
    let filtered_irate_data = null;
    let filteredFips = null;
    let hlightPoints= null;
    let irate_data = null;
    let county_data = null;
    let geoJson = null;
    // declare filters
    var filters = new Filters();

    // previously selected county vars
    let prevCountyFips = null;
    let prevCountyElem = null;
    let prevCountColor = null;

    // map zoom level
    let mapZoom = {'k': 1, 'x': 1, 'y':1};
    

    // select the svg elements
    let svgMap = d3.select("#canvasMap");
    let svgScatter = d3.select("#canvasScatter");

    // load the data sources:
    // Source 1: county meta
    let covid19="data/countymeta.csv";
    // Source 2: time series infection rate data
    let iratefile = "data/irate.csv";
    // Source 3: US Census Counties geojson
    let geojson = "data/us_counties_topo.json";

    Promise.all(
        [
            d3.json(geojson),
            d3.csv(covid19),
            d3.csv(iratefile)],d3.autoType()).then(main)
    
    function checkToggleRegion(elem, region){
        filters.toggleRegion(elem, region);
    }

    function main(data){    
        geoJson = topojson.feature(data[0],data[0].objects.cb_2018_us_county_20m).features;
        county_data = d3.group(data[1],function(d){return d.fips;}); // groups of fips
        irate_data = data[2];
        filtered_irate_data = irate_data;
        hlightPoints = [];

        // set the init filters limits based on data extent
        filters.setInitLimits(irate_data, county_data);
        
        // set-up jQueryUI filter widgets
        $( "#filteredCount" ).text(irate_data.length);
        filters.applyjQUI();
        

        // get initial filtered fips and do intial drawing
        applyFilters();
    }

    function drawMap(){    
        let projection = d3.geoAlbersUsa()
                        .scale(1300).translate([500, 400]);
        let geo_generator = d3.geoPath().projection(projection);

        let density_extent = d3.extent(county_data,function (d){
            return getColor(+d.density);
        })
        
        density_extent[0]=1
        let colorScale = d3.scaleLinear()
            .domain(density_extent)
            .range(["green","red"])
        svgMap.selectAll('g').remove();
        let mapCanvas = svgMap.append('g')
        mapCanvas.selectAll('path')
            .data(geoJson)
            .enter()
            .append('path')
            .attr("class","path_geo")
            .attr("d",geo_generator)
            .on("mousemove",function (mouseData,d){
                d3.selectAll('.tooltip').remove();
                d3.selectAll('.tooltipScatter').remove();
                d3.select('body')
                    .append("div")
                    .classed('tooltip',true)
                    .style("opacity",.9)
                    .style("left",(mouseData.x + 10).toString() +"px")
                    .style("top",(mouseData.y + 10).toString()+"px")
                    .html(
                        "<div class='tooltipData'>County: "+county_data.get(d.properties.GEOID)[0].cname+"</div>" +
                        "<div class='tooltipData'>State: "+county_data.get(d.properties.GEOID)[0].sname+"</div>" +
                        "<div class='tooltipData'>Pop Density: "+county_data.get(d.properties.GEOID)[0].density.toString()+" / sq. mile</div>" 
                    )
            })
            .on("mouseleave",function (mouseData,d){
                d3.selectAll('.tooltip').remove();
                d3.selectAll('.tooltipScatter').remove();

            })
            .on("click",function (mouseData,d){
                // if the same county is clicked then unhightlight and put reg line back
                if(d.properties.GEOID == prevCountyFips){
                    let countyElem = d3.select(this);
                    countyElem.attr('fill', prevCountColor);
                    prevCountColor = null;
                    prevCountyElem = null;
                    prevCountyFips = null;
                    hlightPoints = [];

                    // remove any old highlighted points
                    svgScatter.select('#hlightGrp').remove();

                    // draw regression line
                    linRegr();
                }
                else{
                    // unhighlight selected county back to original color - if one is
                    if(!(prevCountyElem === null)){
                        prevCountyElem.attr('fill', prevCountColor);
                    }

                    // will draw a highlighted point over data point 
                    // faster than assigning class to each point
                    // and then letting d3 select by class
                    // update highlighted array and then call to draw highleted points
                    hlightPoints = [];
                    hlightPoints = irate_data.filter(function(item){
                            return item.fips == d.properties.GEOID;
                    })

                    // update previous selected county to this one
                    prevCountyElem = d3.select(this);
                    prevCountColor = prevCountyElem.attr('fill');
                    prevCountyFips = d.properties.GEOID;

                    // change selected fill color
                    prevCountyElem.attr('fill', 'rgb(117, 166, 189)');

                    // only draw if there are points to draw
                    if(hlightPoints.length > 0){
                        drawHighLightedData();
                    }
                }
            })

            .transition()
            .delay(function (d,i){return i/2})
            .duration(100)
            .attr("fill",function (d){
                try{
                    let density = county_data.get(d.properties.GEOID)[0].density;
                    let stateID = (d.properties.GEOID).substring(0,2);
                    
                    if(density >= filters.lowPopDen && density < filters.highPopDen 
                        && filters.stateFilter.includes(stateID)
                        && filteredFips.includes(d.properties.GEOID)){
                        let tmp = getColor(density);
                        return colorScale(tmp);
                    }
                    else{
                        return 'gray';
                    }
                }
                catch (error)
                {
                    return "white"
                }
            })
        
        // apply zoom setting and attach callbacks
        mapCanvas.attr('transform', mapZoom);
        svgMap.call(d3.zoom()
            .extent([[0,0],[1000,800]])
            .scaleExtent([1,8])
            .on("zoom",zoomedMap)
        )
        function zoomedMap({transform}){
            mapCanvas.attr("transform",transform)
            mapZoom = transform;
        }

        //Title
        let mapTitleSVG = d3.select('#canvasMapTitle');
        mapTitleSVG.selectAll('g').remove();
        mapTitleSVG.append("g")
            .attr("text-anchor", "middle")
            .attr('transform','translate(500,25)')
            .append("text")
            .attr('font-size', '24px')
            .attr('font-family','Arial, Helvetica, sans-serif')
            .text("Population Density / Square Mile")
    }

    function applyFilters(){
        // remove any lines and labels
        svgScatter.selectAll('.lineLabel').remove();
        svgScatter.selectAll('line').remove();

        filteredFips = [];
        let tmpfil = irate_data.filter(function(item, index){
                let density = +county_data.get(item.fips)[0].density;
                let stateID = item.fips.substring(0,2);

                if(!(filteredFips.includes(item.fips) )){
                    filteredFips.push(item.fips);
                }
                return item.rate <= filters.highIrate &&
                    item.rate >= filters.lowIrate &&
                    item.temp >= filters.lowTemp &&
                    item.temp <= filters.highTemp &&
                    density <= filters.highPopDen &&
                    density >= filters.lowPopDen &&
                    new Date(item.week) >= filters.lowDate &&
                    new Date(item.week) <= filters.highDate &&
                    filters.stateFilter.includes(stateID);
                    
        });

        $( "#filteredCount" ).text(tmpfil.length);
        
        filtered_irate_data = tmpfil;
        
        // draw visulaization elements
        drawBar('canvasBarTemp', 'temp');
        drawBar('canvasBarIRate', 'irate');
        drawScatter();
        drawHighLightedData();
        drawMap();
    }

    // used to draw both barcharts - called twice
    function drawBar(svgContainer, type){
        let avgMap = null;
        let height = 370;
        let width = 1000;
        let margin = 70;

        // group the data by date
        avgMapTemp = d3.rollup(filtered_irate_data,
                            v => d3.mean(v, d => d.temp), 
                            d => d.week);

        sumMapCases = d3.rollup(filtered_irate_data,
                            v => d3.sum(v, d => d.cases), 
                            d => d.week);

        // transform into array of JSON - need to sort by date
        let barData = [];
        avgMapTemp.forEach(function(value, key, i){
            barData.push({
                date: new Date(key),
                temp: value,
                cases: sumMapCases.get(key),
                dType: type,
            })
        })
        barData = barData.sort(function(a,b){
            if(a.date > b.date){return 1}
            if(a.date < b.date){return -1;}
            return 0;
        })

        // extents and scales
        let xExtent = d3.extent(barData, function(d,i){
                return i;
        })
        let xExtentDate = d3.extent(barData, function(d,i){
                return new Date(d.date);
        })
        let xScale = d3.scaleLinear()
                        .domain(xExtent)
                        .range([margin, width - margin]);
        let xScaleDate = d3.scaleTime()
                        .domain(xExtentDate)
                        .range([margin, width - margin]);

        let yExtent = d3.extent(barData, function(d){
            if(type == 'temp'){
                return d.temp;
            }
            else{
                return d.cases;
            }
        })
  
        let yScale = d3.scaleLinear()
            .domain(yExtent)
            .range([height -10, 10])

        // color Scale - for temp use low and high from filter - entire data set
        colorScale = null;
        if(type == 'temp'){
            colorScale = d3.scaleLinear()
                .domain([filters.lowWeeklyTempI, filters.highWeeklyTempI])
                .range([1,0])
        }
        else{
            colorScale = d3.scaleLinear()
                .domain([filters.lowWeeklyCaseTotI, filters.highWeeklyCaseTotI])
                .range([1,0])
        }

        let tmpSVG = d3.select('#' + svgContainer)
        tmpSVG.selectAll('.bars').remove()
        tmpSVG.selectAll('.bars')
            .data(barData)
            .enter()
            .append('rect')
            .attr('class',function(d){
                // assign class to pair the barchart charts by date for highlighting mouse over
                return 'b' + d.date.getTime();
            })
            .classed('bars', true)
            
            .attr('x', function(d,i){
                return xScale(i);
            })
            .attr('y', function(d){
                var val = 0;
                if(type == 'temp'){
                    val = d.temp;
                }
                else{
                    val = d.cases;
                }
                return yScale(val);
            })
            .attr('height', function(d){
                var val = 0;
                if(type == 'temp'){
                    val = d.temp;
                }
                else{
                    val = d.cases;
                }
                return height - yScale(val);
            })
            .attr('width', function(d){
                return (width-2*margin)/ barData.length;
            })
            .attr('fill', function(d,i){
                if(type == 'temp'){
                    return d3.interpolateRdYlBu(colorScale(d.temp));
                }
                else{
                    return d3.interpolateRdYlBu(colorScale(d.cases));
                }
            })
            .on("mousemove",function (mouseData,d,i){
                // get the corresponding bar chart element
                let othBar = null;
                if(d.dType == 'temp'){
                    othSVG = d3.select('#canvasBarIRate')
                    othBar = othSVG.select('.b' + d.date.getTime())
                }
                else{
                    othSVG = d3.select('#canvasBarTemp')
                    othBar = othSVG.select('.b' + d.date.getTime())
                }

                // reset all bar strokes
                d3.selectAll('.bars').classed('outline',false)

                // outline 2 corresponding bars
                othBar.classed('outline',true);
                d3.select(this).classed('outline',true);

                // add tooltip
                d3.selectAll('.tooltip').remove();
                d3.selectAll('.tooltipScatter').remove();
                d3.select('body')
                    .append("div")
                    .classed('tooltipScatter',true)
                    .style("opacity",.9)
                    .style("left",(mouseData.x -170).toString() +"px")
                    .style("top",(mouseData.y + 10).toString()+"px")
                    .style('height', '60px')
                    .style('width', '150px')
                    .html(function(){
                        return "<div class='tooltipData' style='text-align:center;font-weight:bold'></div>" +
                        "<div class='tooltipData'><b>Date:</b> "+ d.date.toDateString() +"</div>" +
                        "<div class='tooltipData'><b>Temperature:</b> "+ d.temp.toFixed(1) +"\u00B0 F</div>" +
                        "<div class='tooltipData'><b>Weekly Cases:</b> "+ d.cases +"</div>"
                    })
            })
            .on("mouseleave",function (mouseData,d){
                d3.selectAll('.tooltip').remove();
                d3.selectAll('.tooltipScatter').remove();
                d3.selectAll('.bars').classed('outline',false)
            })

        // draw the x(time axis)
        let xSVG = d3.select('#canvasBarDateAxis');
        xsvg = xSVG.selectAll('g').remove();

        var xAxis = d3.axisBottom()
            .scale(xScaleDate)
            .tickFormat(function(d){
                return (d.getMonth() + 1) +'/' + d.getFullYear();
            })
        
        xSVG.append('g')
            .attr('transform','translate(0,0)')
            .attr('class', 'axis')
            .style("font-size", "16px")
            .call(xAxis);

        // draw the y(data axis)
        tmpSVG.selectAll('g').remove();

        var yAxis = d3.axisLeft()
            .scale(yScale)
            .tickFormat(function(d){
                if(type == 'temp'){
                    return d+ '\u00B0';
                }
                else{
                    return d/1000 + 'K';
                }
            })
        
        tmpSVG.append('g')
            .attr('transform','translate('+ margin + ',0)')
            .attr('class', 'axis')
            .style('font-size', '16px')
            .call(yAxis);
        
        //Title
        let barTitleSVG = d3.select('#canvasBarTitle');
        barTitleSVG.selectAll('g').remove();
        barTitleSVG.append("g")
            .attr("text-anchor", "middle")
            .attr('transform','translate(500,25)')
            .append("text")
            .attr('font-size', '24px')
            .attr('font-family','Arial, Helvetica, sans-serif')
            .text("Time Series Comparison: Cases and Temperature")
    }

    function drawHighLightedData(){
        // the highlighted point array was updated on map click
        // draw on top of the scatter plot here
        // uses scales calculated in scatter draw so it's not done twice

        // remove linear regression line if highlighted pints to draw
        if(hlightPoints.length > 0){
            svgScatter.selectAll('.linregline').remove();
        }

        // create colorscale to better visualize time series 
        let hlightExtent = d3.extent(hlightPoints, function(d){
            return new Date(d.week);
        });

        let hlightScale = d3.scaleLinear()
            .domain(hlightExtent)
            .range([0,1]);

        // remove any old highlighted points
        svgScatter.select('#hlightGrp').remove();

        // add highlighted points in group - easier to remove old ones
        let hlightGrp = svgScatter.append('g')
        hlightGrp.attr('id', 'hlightGrp')

        // line
        var line = d3.line()
                    .x(function(d){return filters.currTempScale(d.temp)})
                    .y(function(d){return filters.currIrateScale(d.rate)});
            
        hlightGrp.append('path')
            .datum(hlightPoints)
            .attr('stroke', 'black')
            .attr('stroke-width', 1)
            .attr('d', line)
            .style('fill', 'none');

        // the points
        hlightGrp.selectAll('circle')
            .data(hlightPoints)
            .enter()
            .append('circle')
            .classed('hlight', true)
            .attr('cx',function(d){
                return filters.currTempScale(+d.temp);
            })
            .attr('cy',function(d){
                if(+d.rate == 0){
                    return filters.currIrateScale(Math.log10(.000001)) ;
                }
                return filters.currIrateScale((+d.rate)) ;
            })
            .attr('r', 0)
            .attr("fill", 'black')
            .on("mousemove",function (mouseData,d){
                d3.selectAll('.tooltip').remove();
                d3.selectAll('.tooltipScatter').remove();
                d3.select('body')
                    .append("div")
                    .classed('tooltipScatter',true)
                    .style("opacity",.9)
                    .style("left",(mouseData.x -150).toString() +"px")
                    .style("top",(mouseData.y + 10).toString()+"px")
                    .html(
                        "<div class='tooltipData' style='text-align:center;font-weight:bold'>County: "+county_data.get(d.fips)[0].cname+", " +
                        county_data.get(d.fips)[0].sname+"</div>" +
                        "<div class='tooltipData'>Date: "+d.week+"</div>" +
                        "<div class='tooltipData'>Infection Rate: "+d.rate+"</div>" +
                        "<div class='tooltipData'>Temperature: "+d.temp+"&#176;F</div>" 
                    )
            })
            .on("mouseleave",function (mouseData,d){
                d3.selectAll('.tooltip').remove();
                d3.selectAll('.tooltipScatter').remove();

            })
            .transition()
            .delay(function (d,i){return i * 10})
            .duration(150)
            .attr('r',6)
            .transition()
            .delay(function (d,i){return i * 10})
            .duration(150)
            .attr('r',5)
            .attr('stroke', 'none')
            .attr('fill', function(d){
                return d3.interpolateRdYlGn(hlightScale(new Date(d.week)));
            });

            // redraw axises and labels - hide out of bounds points
            scatterAxises();
    }

    function drawScatter(){
        // margins - also set in filters so lines draw correctly
        let margT = 20;
        let margB = 30;
        let margL = 60;
        let margR = 5;
        filters.margT = margT;
        filters.margR = margR;
        filters.margL = margL;
        filters.margB = margB;

        // Extents
        let irateExtent = d3.extent(filtered_irate_data, function(d){
            return +d.rate;
        })
        let tempExtent = d3.extent(filtered_irate_data, function(d){
            return +d.temp;
        })

        // Scales -set in filters, so highlighting points do not have to recalculate
        var tempScale = d3.scaleLinear()
            .domain(tempExtent)
            .range([margL, 1000 - margR])
        var irateScale = d3.scaleLinear()
            .domain(irateExtent)
            .range([200 - margB, margT])
        filters.currTempScale = tempScale;
        filters.currIrateScale = irateScale;

        let density_extent = d3.extent(county_data,function (d){
            return getColor(+d.density);
        })
        
        density_extent[0]=1
        let colorScale = d3.scaleLinear()
            .domain(density_extent)
            .range(["green","red"])
        
        // remove old brush
        svgScatter.select('.brush').remove();
        
        // remove old circles
        svgScatter.selectAll('g').remove();
        let scatterCanvas = svgScatter.append('g')

        scatterCanvas.selectAll('circle')
            .data(filtered_irate_data)
            .enter()
            .append('circle')
            .attr('cx',function(d){
                return tempScale(+d.temp);
            })
            .attr('cy',function(d){
                if(+d.rate == 0){
                    return irateScale(Math.log10(.000001)) ;
                }
                return irateScale((+d.rate)) ;
            })
            .attr('r', .4)
            .style("fill", function(d){
                try{
                    // let density = county_data.get(d.fips)[0].density;
                    // let tmp = getColor(density);
                    // return colorScale(tmp);
                    //return 'rgb(236, 148, 148)';
                    return 'gray';
                }
                catch (error)
                {
                    console.log(error)
                    return "white"
                }
            })

        // Brush
        let brushg = svgScatter.append('g');
        let brush = brushg.call(d3.brush()
            .extent([[margL,margT],[1000 - margR, 200 - margB]])
            .on('end', updateScatterBrush)
        )
        
        scatterAxises();

        // calc and draw linear regression
        linRegr();

        function updateScatterBrush({selection}){
            // get the bounds of the selected area scaled to irate and temperature
            // set the 
            filters.lowTemp = Math.floor(tempScale.invert(selection[0][0]));
            filters.highTemp = Math.ceil(tempScale.invert(selection[1][0]));
            filters.lowIrate = irateScale.invert(selection[1][1]);
            filters.highIrate = irateScale.invert(selection[0][1]);

            $( "#irateSlider" ).slider('values',0,Math.log10(filters.lowIrate));
            $( "#irateSlider" ).slider('values',1,Math.log10(filters.highIrate));
            $( "#irateSliderTxt" ).text(Math.floor(filters.lowIrate) + " - " + Math.ceil(filters.highIrate));

            $( "#tempSlider" ).slider('values',0,filters.lowTemp);
            $( "#tempSlider" ).slider('values',1,filters.highTemp);
            $( "#tempSliderTxt" ).text(filters.lowTemp + " - " + filters.highTemp);

            applyFilters();
        }
    }

    function scatterAxises(){
        // background rectangles for hiding out of bounds points
        // needed for left and top
        d3.selectAll('.axisBkgrnd').remove();
        svgScatter.append('rect')
            .classed('axisBkgrnd', true)
            .attr('x', 0)
            .attr('y', 0)
            .attr('height', 200)
            .attr('width', filters.margL)
        svgScatter.append('rect')
            .classed('axisBkgrnd', true)
            .attr('x', 0)
            .attr('y', 0)
            .attr('height', filters.margT)
            .attr('width', 1000)

        //Title
        svgScatter.append("g")
            .attr("text-anchor", "middle")
            .attr('transform','translate(500,' + filters.margT + ")")
            .append("text")
            .attr('font-size', '12px')
            .attr('font-family','Arial, Helvetica, sans-serif')
            .text("Infection Rate vs Temperature")

        // Axises
        var tempAxis = d3.axisBottom()
            .scale(filters.currTempScale)
            .tickFormat(function(d){
                return d + '\u00B0';
            })
        
        svgScatter.append('g')
            .attr('transform','translate(0,' + (200 - filters.margB) + ")")
            .attr('class', 'axis')
            .call(tempAxis);
        
        var iRateAxis = d3.axisLeft()
            .scale(filters.currIrateScale)
            
        svgScatter.append('g')
            .attr('transform','translate(' + (filters.margL) + ',0)')
            .attr('class', 'axis')
            .call(iRateAxis);

        // Axis Labels
        svgScatter.append("g").attr("class","label")
            .attr('transform','translate(500,' + (200-2) + ")")
            .append("text")
            .attr('font-size', '11px')
            .attr('font-family','Arial, Helvetica, sans-serif')
            .text("Temperature \u00B0F")

        svgScatter.append("g")
            .attr("text-anchor", "middle") 
            .attr("transform", `translate(${10},${200/2}) rotate(270)`)
            .append("text")
            .attr('font-size', '11px')
            .attr('font-family','Arial, Helvetica, sans-serif')
            .attr('text-rendering','optimizeLegibility')
            .text("7 Day Cases / 100k pop")
    }

    // displays best fit straight line of filtered data
    // code from: https://stackoverflow.com/questions/6195335/linear-regression-in-javascript
    function linRegr(){
        var lr = {};
        var sum_x = 0;
        var sum_y = 0;
        var sum_xy = 0;
        var sum_xx = 0;
        var sum_yy = 0;

        // remove old line
        svgScatter.selectAll('.linregline').remove();

        // if there are no highlighted (county selected) points the draw line
        // also there has to data
        if(hlightPoints.length == 0 && filtered_irate_data.length > 0){
            // get x and y
            let x = [];
            let y = [];
            for (var i =0; i < filtered_irate_data.length; i++){
                x.push(+filtered_irate_data[i].temp);
                y.push(+filtered_irate_data[i].rate)
            }

            var n = y.length;

            for (var i = 0; i < y.length; i++) {

                sum_x += x[i];
                sum_y += y[i];
                sum_xy += (x[i]*y[i]);
                sum_xx += (x[i]*x[i]);
                sum_yy += (y[i]*y[i]);
            } 

            lr['slope'] = (n * sum_xy - sum_x * sum_y) / (n*sum_xx - sum_x * sum_x);
            lr['intercept'] = (sum_y - lr.slope * sum_x)/n;
            lr['r2'] = Math.pow((n*sum_xy - sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y)),2);

            // y intercept
            let yInt = lr['intercept'];
            if(yInt < 0){
                yInt = (lr['slope'] * filters.highTemp) + lr['intercept']
            }

            // x intercept
            let xInt = lr['intercept']/ (lr['slope'] * -1.0);

            // calculate x1,x2,y1,y1
            let x1 = x2 = y1 = y2 = 0.0;
            if(lr['slope'] < 0){
                x1 = filters.margL;
                x2 = filters.currTempScale(xInt);
                y1 = filters.currIrateScale(yInt);
                y2 = 200 - filters.margB;
            }
            else{
                x1 = 1000 - filters.margR;
                x2 = filters.currTempScale(xInt);
                y1 = filters.currIrateScale(yInt);
                y2 = 200 - filters.margB;
            }

            // add the line
            let lrg = svgScatter.append('g')
            lrg.attr('class', 'linregline');

            lrg.append('line')
                .datum(lr)
                .style("stroke", "red")  
                .style("stroke-width", "1px")  
                .attr("x1", function(){return x1})    
                .attr("y1", function(){return y1})     
                .attr("x2", function(){return x2})    
                .attr("y2", function(){return y2})
                .on("mousemove",function (mouseData,d){
                    d3.selectAll('.tooltip').remove();
                    d3.selectAll('.tooltipScatter').remove();
                    d3.select('body')
                        .append("div")
                        .classed('tooltipScatter', true)
                        .style("opacity",.9)
                        .style('font-weight','bold')
                        .style("left",(mouseData.x -150).toString() +"px")
                        .style("top",(mouseData.y + 10).toString()+"px")
                        .style('height', '40px')
                        .style('width', '175px')
                        .html(
                            "<div class='tooltipData'>Line: y = " +d.slope.toFixed(2) + "x + " +  d.intercept.toFixed(2) + "</div>" +
                            "<div class='tooltipData'>r2: "+d.r2.toFixed(2)+"</div>"
                        )
                })
                .on("mouseleave",function (mouseData,d){
                    d3.selectAll('.tooltip').remove();
                    d3.selectAll('.tooltipScatter').remove();

                })
        }
        return lr;
    }

    function resetFilters(){
        // reset map scale and center
        mapZoom = {'k': 1, 'x': 1, 'y':1};

        // clear selected county highlighted points
        hlightPoints = [];
        
        // set the filter back to intial values
        filters.resetFiltersValues();   

        // get initial filtered fips and do intial drawing
        applyFilters();
    }

    function getColor(density){
        if(density < 25){
            return 0;
        }
        if(density < 50){
            return 1;
        }
        if(density < 75){
            return 2;
        }
        if(density < 100){
            return 3;
        }
        if(density < 150){
            return 4;
        }
        if(density < 200){
            return 5;
        }
        if(density < 300){
            return 6;
        }
        if(density < 500){
            return 7;
        }
        if(density < 700){
            return 8;
        }
        if(density < 1000){
            return 9;
        }
        if(density < 2000){
            return 10;
        }
        return 11
    }

    function checkBoxEvt(elem, stateID){
        let tmpArr = [];
        if(elem.checked){
            filters.stateFilter.push(stateID);
        }
        else{
            tmpArr = filters.stateFilter.filter(function(val){
                if(val != stateID){
                    return val
                }
            })
            filters.stateFilter = tmpArr;
        }
        
        applyFilters();
    }

    function toggleExpand(id){
        let elem = d3.select('#' + id);
        if(elem.classed('stateFilterEX')){
            elem.classed('stateFilterEX', false);
            elem.classed('stateFilterCOL', true);
            elem.select('span')
                .text('+')
        }
        else{
            elem.classed('stateFilterEX', true);
            elem.classed('stateFilterCOL', false);
            elem.select('span')
                .text('-')
        }
    }

</script>
</body>
</html>








